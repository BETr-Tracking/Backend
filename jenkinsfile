pipeline {

    environment {
        docker_image = ""
        DOCKERHUB_CREDENTIALS=credentials('DockerHubCred')
    } 
    agent any

    stages {
        stage('1. Git Clone - Backend') {
            steps {
                script { 
                    git branch: 'main', url: "https://github.com/BETr-Tracking/Backend.git"
                }
            }
        }
        stage('2. Maven Build') {
            steps {
                    sh 'mvn clean install'
            }
        }
        

        stage('3. Build Docker Image') {
            steps {
                script{
                        sh 'docker build -t svp3012/betr-backend .'
                }
                
            }
        }
        stage('4. Push Docker Image') {
            steps {
                script{
                    sh 'docker push svp3012/betr-backend'
                }
            }
        }
        stage('5. Git Clone - Frontend') {
            steps {
                script { 
                    git branch: 'main', url: "https://github.com/BETr-Tracking/Frontend.git"
                }
            }
        }
        stage('6. Build Docker Image') {
            steps {
                script{
                        
                    sh 'docker build --build-arg REACT_APP_API_URL=https://api.example.com --build-arg REACT_APP_DEBUG=true -t svp3012/betr-frontend-app .'
                }
                
            }
        }
        stage('7. Dockerhub Login') {
            steps {
				sh 'echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin'
			}
		}
        stage('8. Push Docker Image') {
            steps {
                script{
                    sh 'docker push svp3012/betr-frontend-app'
                }
            }
        }
       stage('6. Run Ansible Playbook') {
            steps {
                ansiblePlaybook becomeUser: null,
                colorized: true, 
                credentialsId: 'localhost', 
                disableHostKeyChecking: true, 
                inventory: 'Devops/inventory', 
                playbook: 'Devops/deploy.yml', 
                vaultTmpPath: '',
                sudoUser: null
            }
        }

    }
    post {
		always {
			sh 'docker logout'
		}
	}
}
